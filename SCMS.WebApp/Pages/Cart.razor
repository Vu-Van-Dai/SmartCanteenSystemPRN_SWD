@page "/cart"
@attribute [Authorize]

@implements IDisposable
@inject CartService CartService
@inject OrderService OrderService
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@inject ConfirmDialogService DialogService

@if (CartService.EditingOrderId.HasValue)
{
    <h3>Chỉnh sửa Đơn hàng #@CartService.EditingOrderId</h3>
}
else
{
    <h3>Giỏ hàng của bạn</h3>
}


@if (!CartService.Items.Any())
{
    <p>Giỏ hàng của bạn đang trống. Hãy chọn món trong <a href="/menu">thực đơn</a>!</p>
}
else
{
    <table class="table">
        @* ... Toàn bộ table không thay đổi ... *@
        <thead>
            <tr>
                <th>Món ăn</th>
                <th>Đơn giá</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in CartService.Items)
            {
                <tr>
                    <td>@item.MenuItemName</td>
                    <td>@item.Price.ToString("N0")</td>
                    <td>
                        <InputNumber @bind-Value="item.Quantity" @oninput="(e) => UpdateQuantity(item, e)" min="1" class="form-control" style="width: 80px;" />
                    </td>
                    <td>@((item.Price * item.Quantity).ToString("N0"))</td>
                    <td>
                        <button class="btn btn-danger btn-sm" @onclick="() => CartService.RemoveItem(item.MenuItemId)">
                            <span class="oi oi-trash"></span>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" class="text-end"><strong>Tổng cộng:</strong></td>
                <td colspan="2"><strong>@CartService.GetTotalPrice().ToString("N0") VNĐ</strong></td>
            </tr>
        </tfoot>
    </table>

    <div class="mb-3">
        <label for="pickupTime" class="form-label"><strong>Chọn thời gian nhận hàng (để trống nếu nhận ngay):</strong></label>
        <input type="datetime-local" id="pickupTime" class="form-control" @bind="pickupTime" />
        <small class="form-text text-muted">Nếu bạn đặt trước, phí hủy đơn sẽ được tính dựa trên thời gian nhận hàng.</small>
    </div>
    <button class="btn @(CartService.EditingOrderId.HasValue ? "btn-primary" : "btn-success")" @onclick="HandleSubmitOrder">
        @if (CartService.EditingOrderId.HasValue)
        {
            <span class="oi oi-loop-circular"></span>
            <span> Cập nhật Đơn hàng</span>
        }
        else
        {
            <span class="oi oi-check"></span>
            <span> Tiến hành Đặt hàng</span>
        }
    </button>

}

@code {
    private Action _cartServiceOnChange;
    private DateTime? pickupTime;

    protected override void OnInitialized()
    {
        _cartServiceOnChange = () => InvokeAsync(StateHasChanged);
        CartService.OnChange += _cartServiceOnChange;

    }

    public void Dispose()
    {
        CartService.OnChange -= _cartServiceOnChange;
    }

    private void UpdateQuantity(OrderItemDto item, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int quantity))
        {
            CartService.UpdateQuantity(item.MenuItemId, quantity);
        }
    }

    private async Task HandleSubmitOrder()
    {
        bool isEditing = CartService.EditingOrderId.HasValue;
        string title = isEditing ? "Xác nhận cập nhật" : "Xác nhận đặt hàng";
        string message = isEditing
            ? $"Bạn có chắc chắn muốn cập nhật các thay đổi cho đơn hàng #{CartService.EditingOrderId.Value} không?"
            : "Bạn có chắc chắn muốn đặt hàng không?";

        if (await DialogService.Show(title, message))
        {
            var orderDto = new PlaceOrderRequestDto
                {
                    Items = CartService.Items,
                    PickupTime = pickupTime
                };
            bool success = false;
            string successMessage = "";

            if (isEditing)
            {
                var result = await OrderService.UpdateOrderAsync(CartService.EditingOrderId.Value, orderDto);
                if (result != null)
                {
                    success = true;
                    successMessage = $"Cập nhật đơn hàng #{CartService.EditingOrderId.Value} thành công!";
                }
            }
            else
            {
                var result = await OrderService.PlaceOrderAsync(orderDto);
                if (result != null)
                {
                    success = true;
                    successMessage = "Đặt hàng thành công!";
                }
            }

            if (success)
            {
                ToastService.ShowToast(successMessage);
                CartService.ClearCart();
                NavigationManager.NavigateTo("/my-orders");
            }
            else
            {
                ToastService.ShowToast("Thao tác thất bại. Vui lòng thử lại.", ToastLevel.Danger);
            }
        }
    }
}