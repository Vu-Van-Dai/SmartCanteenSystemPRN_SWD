@page "/force-change-password"
@attribute [Authorize]
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@using System.IdentityModel.Tokens.Jwt 

<PageTitle>Đổi mật khẩu lần đầu</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="text-center mb-4">
            <h3 class="mt-2">Thiết lập mật khẩu mới</h3>
            <p class="text-muted">Vì lý do bảo mật, vui lòng đổi mật khẩu trong lần đăng nhập đầu tiên.</p>
        </div>

        @if (!string.IsNullOrEmpty(changePasswordMessage))
        {
            <div class="alert @(changePasswordSuccess ? "alert-success" : "alert-danger")">@changePasswordMessage</div>
        }

        <EditForm Model="changeDto" OnValidSubmit="HandleChangePassword">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label>Mật khẩu cũ (mật khẩu tạm thời)</label>
                <InputText @bind-Value="changeDto.OldPassword" type="password" class="form-control" />
                <ValidationMessage For="@(() => changeDto.OldPassword)" />
            </div>

            <div class="mb-3">
                <label>Mật khẩu mới</label>
                <InputText @bind-Value="changeDto.NewPassword" type="password" class="form-control" />
                <ValidationMessage For="@(() => changeDto.NewPassword)" />
            </div>

            <div class="mb-3">
                <label>Xác nhận mật khẩu mới</label>
                <InputText @bind-Value="confirmPassword" type="password" class="form-control" />
            </div>

            <button type="submit" class="btn btn-primary w-100" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm"></span>
                }
                Lưu thay đổi và đăng nhập
            </button>
        </EditForm>
    </div>
</div>

@code {
    private ChangePasswordDto changeDto = new();
    private string confirmPassword = "";
    private string? changePasswordMessage;
    private bool changePasswordSuccess = false;
    private bool isSubmitting = false;
    private string userEmailForRelogin = "";

    private async Task HandleChangePassword()
    {
        changePasswordMessage = null;
        if (changeDto.NewPassword != confirmPassword)
        {
            changePasswordMessage = "Mật khẩu mới và mật khẩu xác nhận không khớp.";
            changePasswordSuccess = false;
            return;
        }

        isSubmitting = true;

        var response = await AuthService.ChangePasswordAsync(changeDto);
        if (response.IsSuccessStatusCode)
        {
            changePasswordSuccess = true;
            changePasswordMessage = "Đổi mật khẩu thành công! Tự động đăng nhập lại...";

            await Task.Delay(1500);

            var loginResult = await AuthService.LoginAsync(new LoginDto { Email = userEmailForRelogin, Password = changeDto.NewPassword });
            if (loginResult.Success && !loginResult.MustChangePassword)
            {
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                changePasswordMessage = "Đã xảy ra lỗi khi tự động đăng nhập lại. Vui lòng thử đăng nhập thủ công.";
            }
        }
        else
        {
            changePasswordSuccess = false;
            changePasswordMessage = "Mật khẩu cũ không đúng hoặc đã xảy ra lỗi. Vui lòng thử lại.";
        }

        isSubmitting = false;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var emailClaim = user.FindFirst(c => c.Type == JwtRegisteredClaimNames.Email);

        if (emailClaim != null)
        {
            userEmailForRelogin = emailClaim.Value;
        }
    }
}